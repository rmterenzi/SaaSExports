///$tab Main
SET ThousandSep=',';
SET DecimalSep='.';
SET MoneyThousandSep=',';
SET MoneyDecimalSep='.';
SET MoneyFormat='$ ###0.00;-$ ###0.00';
SET TimeFormat='h:mm:ss TT';
SET DateFormat='M/D/YYYY';
SET TimestampFormat='M/D/YYYY h:mm:ss[.fff] TT';
SET FirstWeekDay=6;
SET BrokenWeeks=1;
SET ReferenceDay=0;
SET FirstMonthOfYear=1;
SET CollationLocale='en-US';
SET CreateSearchIndexOnReload=1;
SET MonthNames='Jan;Feb;Mar;Apr;May;Jun;Jul;Aug;Sep;Oct;Nov;Dec';
SET LongMonthNames='January;February;March;April;May;June;July;August;September;October;November;December';
SET DayNames='Mon;Tue;Wed;Thu;Fri;Sat;Sun';
SET LongDayNames='Monday;Tuesday;Wednesday;Thursday;Friday;Saturday;Sunday';
SET NumericalAbbreviation='3:k;6:M;9:G;12:T;15:P;18:E;21:Z;24:Y;-3:m;-6:Î¼;-9:n;-12:p;-15:f;-18:a;-21:z;-24:y';

///$tab Auto-generated section
///$autogenerated
Set dataManagerTables = '','Success Stories';
//This block renames script tables from non generated section which conflict with the names of managed tables

For each name in $(dataManagerTables) 
    Let index = 0;
    Let currentName = name; 
    Let tableNumber = TableNumber(name); 
    Let matches = 0; 
    Do while not IsNull(tableNumber) or (index > 0 and matches > 0)
        index = index + 1; 
        currentName = name & '-' & index; 
        tableNumber = TableNumber(currentName) 
        matches = Match('$(currentName)', $(dataManagerTables));
    Loop 
    If index > 0 then 
            Rename Table '$(name)' to '$(currentName)'; 
    EndIf; 
Next; 
Set dataManagerTables = ;


Unqualify *;

[Success Stories]:
LOAD
	[Created By],
	[Service Offering],
	[Sector],
	[Industry],
	[Business Function],
	[Customer],
	[Business Use Case Tags],
	[Tech Use Case Tags],
	[Technology Practice Category],
	[Technology],
	[Title],
	[Summary],
	[Challenge],
	[Solution],
	[Value & Benefit],
	[Business Use Case],
	[Technical Use Case],
	[Display On Website],
	[Story Link],
	[Approval Status]
 FROM [lib://DataFiles/Success Stories.csv]
(txt, utf8, embedded labels, delimiter is ',', msq);





///$tab Transform
Errormode =1;
Fact: 
NoConcatenate Load Distinct * , 
Customer & '|' & Title as Key,
SubField(PurgeChar(PurgeChar(PurgeChar([Service Offering], '['), ']'), Chr(34)), ',') AS ServiceOffering2,
//SubField(PurgeChar(PurgeChar(PurgeChar([Technology], '['), ']'), Chr(34)), ',') AS Technology2,
SubField(PurgeChar(PurgeChar(PurgeChar([Industry], '['), ']'), Chr(34)), ',') AS Industry2,
//SubField(PurgeChar(PurgeChar(PurgeChar([Technology Practice Category], '['), ']'), Chr(34)), ',') AS 'Technology Practice Category 2',
Replace(Summary, '&%23160;', Chr(13)) AS Summary2,
Replace(Challenge, '&%23160;', Chr(13)) AS Challenge2,
Replace(Solution, '&%23160;', Chr(13)) AS Solution2,
Replace([Value & Benefit], '&%23160;', Chr(13)) AS Value2
//SubField(PurgeChar(PurgeChar(PurgeChar([Tech Use Case Tags], '['), ']'), Chr(34)), ',') AS 'Tech Use Case Tags 2',
//SubField(PurgeChar(PurgeChar(PurgeChar([Business Use Case Tags]	, '['), ']'), Chr(34)), ',') AS 'Business Use Case Tags 2',
//SubField(PurgeChar(PurgeChar(PurgeChar([Use Case Tags]			, '['), ']'), Chr(34)), ',') AS 'Use Case Tags 2',
//SubField(PurgeChar(PurgeChar(PurgeChar([Business Function], '['), ']'), Chr(34)), ',') AS 'Business Function 2',
//PurgeChar(PurgeChar([Summary], 'div class='&  Chr(34)), (Chr(60) & 'div' & Chr(62))) AS Summary2
//Replace(Replace(
// , ']',""),'"',"")
Resident [Success Stories] Order By Customer asc;

Tech:
NoConcatenate Load Distinct Key, SubField(PurgeChar(PurgeChar(PurgeChar([Technology], '['), ']'), Chr(34)), ',') AS Technology2
Resident [Fact] Order By Key asc;

TechPracticCat:
NoConcatenate Load Distinct Key, SubField(PurgeChar(PurgeChar(PurgeChar([Technology Practice Category], '['), ']'), Chr(34)), ',') AS 'Technology Practice Category 2'
Resident [Fact] Order By Key asc;

BusinessTags:
//Load Key, [Use Case Tags 2];
//Load *, SubField([Use Case Tags 3], ',') AS 'Use Case Tags 2'; //Key, [Use Case Tags 3]
//Load *, [Business Use Case Tags 2] & ',' & [Tech Use Case Tags 2] AS 'Use Case Tags 3'; 
Load *, 
SubField(PurgeChar(PurgeChar(PurgeChar([Business Use Case Tags]	, '['), ']'), Chr(34)), ',') AS 'Business Use Case Tags 2';
Load [Business Use Case Tags], [Tech Use Case Tags], Customer & '|' & Title as Key
Resident [Success Stories] Order By Customer asc;

TechTags:
//Load *, If(Len([Tech Use Case Tags 2]) > 1, 1) AS 'Tech Use Case Tag Count';
NoConcatenate Load Distinct Key, 
SubField(PurgeChar(PurgeChar(PurgeChar([Tech Use Case Tags], '['), ']'), Chr(34)), ',') AS 'Tech Use Case Tags 2' 
Resident BusinessTags Order By Key asc;

AllTagsTemp:
//Load *, SubField([Use Case Tags 3], ',') AS 'Use Case Tags 2'; //Key, [Use Case Tags 3]
//Load *, [Business Use Case Tags 2] & ',' & [Tech Use Case Tags 2] AS 'Use Case Tags 3'; 
NoConcatenate Load Distinct Key, [Tech Use Case Tags 2] Resident TechTags Order By Key asc; 
Left Join Load Distinct Key, [Business Use Case Tags 2] Resident BusinessTags Order By Key asc;

AllTags:
Load Distinct Key, SubField([Use Case Tags 3], ',') AS 'Use Case Tags 2';
NoConcatenate Load Distinct *,[Business Use Case Tags 2] & ',' & [Tech Use Case Tags 2] AS 'Use Case Tags 3'
Resident AllTagsTemp Order By Key asc; 

'Business Function':
Load Key, SubField(PurgeChar(PurgeChar(PurgeChar([Business Function], '['), ']'), Chr(34)), ',') AS 'Business Function 2';
Load [Business Function], Customer & '|' & Title as Key
Resident [Success Stories];

Drop Fields [Value & Benefit],[Solution],[Challenge],[Service Offering], [Technology],[Technology Practice Category],[Tech Use Case Tags],[Business Use Case Tags]/*,[Use Case Tags](*/, [Business Function], [Summary], [Industry];
Drop Tables [Success Stories], AllTagsTemp;

Rename Fields [Value2] to [Value], [Solution2] to [Solution], [Challenge2] to Challenge, ServiceOffering2 to [Service Offering], Technology2 to [Technology], [Technology Practice Category 2] to [Technology Practice Category], 
[Tech Use Case Tags 2] to [Tech Use Case Tags], [Business Use Case Tags 2] to [Business Use Case Tags] ,[Use Case Tags 2] to [Use Case Tags], [Summary2] to [Summary], 
[Business Function 2] to [Business Function], [Industry2] to [Industry];
